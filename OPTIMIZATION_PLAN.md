#  План оптимизации

---

##  Cлабые места

1. **База данных**
   - На некоторых колонках нет индексов (например, `applications.status`, `applications.user_id`)
   - Возможны N+1 запросы при выборках связанных моделей
   - При одновременной работе нескольких пользователей возможны конфликты при обновлении балансов и заявок
   - Если транзакции держат блокировки слишком долго, это может привести к задержкам
   
2. **Работа с данными**
   - Статистика и агрегаты считаются без оптимизаций.
   - Транзакции не всегда обернуты в единый блок — при ошибках возможна потеря данных

3. **API и архитектура**
   - В коде есть дублирование логики
   - Нет ограничений на количество запросов
   - Логирование минимальное

4. **Инфраструктура**
   - Нет отдельного connection pool для базы
   - Нет мониторинга (нагрузка, ошибки, долгие запросы)
   - Тесты покрывают лишь малую часть сценариев

---

## Что можно улучшить

### P0
- Добавить индексы в Postgres:
  - `applications (status)`, `applications (merchant_id, trader_id)`
  - `balance_transactions (user_id)`
- Проверить и убрать N+1 запросы (через `selectinload` в SQLAlchemy)
- Обернуть все операции с деньгами и заявками в транзакции
- Сделать больше логов для ключевых операций (создание заявки, перевод средств)

### P1
- Добавить rate limiting для API (например, ограничение по IP).
- Ускорить выборку статистики через агрегирующие запросы в SQL
- Написать тесты для массовых операций

### P2
- Подключить Prometheus/Grafana для мониторинга запросов и ошибок
- Настроить PgBouncer для пула подключений к базе
- Подготовить нагрузочные тесты

---

## Быстрые победы
- Добавить индексы
- Убрать N+1 запросы
- Обернуть ключевые операции в транзакции
- Сделать логирование более подробным

---

## План на 1–2 недели
   - Индексы в базе
   - Правка запросов (убрать N+1)
   - Логирование и транзакции
   - Дополнить тесты
   - Rate limiting
   - Оптимизация запросов статистики
   - Первичный мониторинг
